<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiKoGame - AI Knowledge Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        #loading {
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 1000;
            padding: 20px;
        }
        #loading p {
            margin: 10px 0;
        }
        #game-container {
            display: none;
        }
        canvas {
            display: block;
            border: 2px solid #333;
            background: #000;
        }
        .error {
            color: #ff4444;
            background: #220000;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            margin: 20px;
        }
        .info {
            color: #44ff44;
            background: #002200;
            padding: 15px;
            border-radius: 10px;
            max-width: 800px;
            margin: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p>üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ KiKoGame...</p>
        <p id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
    </div>
    <div id="game-container">
        <canvas id="game-canvas" width="1200" height="700"></canvas>
    </div>

    <script type="module">
        import { loadPyodide } from 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';

        let pyodide;
        let gameInitialized = false;

        async function loadPythonFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${filename}: ${response.statusText}`);
                }
                return await response.text();
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}:`, error);
                throw error;
            }
        }

        async function main() {
            const statusEl = document.getElementById('status');
            const loadingEl = document.getElementById('loading');
            const gameContainer = document.getElementById('game-container');
            const canvas = document.getElementById('game-canvas');

            try {
                // –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ Pyodide
                statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ Pyodide (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)...';
                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'
                });

                // –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ micropip –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
                statusEl.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞...';
                await pyodide.loadPackage(['micropip']);

                // –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pygame —á–µ—Ä–µ–∑ micropip
                statusEl.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ pygame (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)...';
                const micropip = pyodide.pyimport('micropip');
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pygame
                    await micropip.install('pygame');
                    statusEl.textContent = 'pygame —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!';
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pygame:', e);
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pygame. –í–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥.');
                }

                // –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö Python —Ñ–∞–π–ª–æ–≤
                statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–≥—Ä—ã...';
                
                const pythonFiles = [
                    'confi.py',
                    'background.py',
                    'spaceship.py',
                    'enemy.py',
                    'Depart.py',
                    'key.py',
                    'planet.py',
                    'departments_data.py',
                    'scores.py',
                    'sound.py',
                    'Test.py',
                    'start_screen.py',
                    'Events.py',
                    'main.py'
                ];

                for (const file of pythonFiles) {
                    statusEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${file}...`;
                    const code = await loadPythonFile(file);
                    pyodide.runPython(code);
                }

                // –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pygame –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                statusEl.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è pygame...';
                
                // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è pygame
                pyodide.runPython(`
import pygame
import sys
import asyncio
from js import document, window

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è pygame
try:
    pygame.init()
    print("pygame –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ pygame: {e}")
    raise

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏—Å–ø–ª–µ—è
try:
    screen = pygame.display.set_mode((1200, 700))
    pygame.display.set_caption("KikoGame")
    print("–î–∏—Å–ø–ª–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏—Å–ø–ª–µ—è: {e}")
    raise
                `);

                // –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
                statusEl.textContent = '–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...';
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
                pyodide.runPythonAsync(`
import main
import asyncio

async def run_game():
    try:
        await main.run()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ –∏–≥—Ä–µ: {e}")
        import traceback
        traceback.print_exc()

# –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
asyncio.create_task(run_game())
                `).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã:', err);
                    statusEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${err.message}`;
                });

                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                    gameContainer.style.display = 'block';
                    gameInitialized = true;
                }, 2000);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
                canvas.addEventListener('mousedown', (e) => {
                    if (!gameInitialized) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
                    const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
                    
                    pyodide.runPython(`
import pygame
try:
    event = pygame.event.Event(pygame.MOUSEBUTTONDOWN, {
        'pos': (${x}, ${y}),
        'button': ${e.button}
    })
    pygame.event.post(event)
except Exception as e:
    pass
                    `);
                });

                canvas.addEventListener('mouseup', (e) => {
                    if (!gameInitialized) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
                    const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
                    
                    pyodide.runPython(`
import pygame
try:
    event = pygame.event.Event(pygame.MOUSEBUTTONUP, {
        'pos': (${x}, ${y}),
        'button': ${e.button}
    })
    pygame.event.post(event)
except Exception as e:
    pass
                    `);
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!gameInitialized) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
                    const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
                    
                    pyodide.runPython(`
import pygame
try:
    event = pygame.event.Event(pygame.MOUSEMOTION, {
        'pos': (${x}, ${y})
    })
    pygame.event.post(event)
except Exception as e:
    pass
                    `);
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                const keyMap = {
                    'ArrowLeft': 'K_LEFT',
                    'ArrowRight': 'K_RIGHT',
                    'ArrowUp': 'K_UP',
                    'ArrowDown': 'K_DOWN',
                    ' ': 'K_SPACE',
                    'Escape': 'K_ESCAPE'
                };

                window.addEventListener('keydown', (e) => {
                    if (!gameInitialized) return;
                    e.preventDefault();
                    const pygameKey = keyMap[e.key];
                    if (pygameKey) {
                        pyodide.runPython(`
import pygame
try:
    key = pygame.${pygameKey}
    event = pygame.event.Event(pygame.KEYDOWN, {'key': key})
    pygame.event.post(event)
except Exception as e:
    pass
                        `);
                    }
                });

                window.addEventListener('keyup', (e) => {
                    if (!gameInitialized) return;
                    e.preventDefault();
                    const pygameKey = keyMap[e.key];
                    if (pygameKey) {
                        pyodide.runPython(`
import pygame
try:
    key = pygame.${pygameKey}
    event = pygame.event.Event(pygame.KEYUP, {'key': key})
    pygame.event.post(event)
except Exception as e:
    pass
                        `);
                    }
                });

            } catch (error) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                statusEl.innerHTML = `<div class="error">
                    <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã</h3>
                    <p><strong>${error.message}</strong></p>
                    <p style="margin-top: 15px; font-size: 14px;">
                        –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, pygame –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ Pyodide.
                    </p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
                        1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <a href="https://replit.com" target="_blank" style="color: #44ff44;">Replit</a> –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Pygame –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>
                        2. –ò–ª–∏ –ø–µ—Ä–µ–ø–∏—à–∏—Ç–µ –∏–≥—Ä—É –Ω–∞ JavaScript/TypeScript –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞<br>
                        3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
                    </p>
                </div>`;
                statusEl.style.color = '#ff4444';
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        main().catch(err => {
            console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
            document.getElementById('status').innerHTML = `<div class="error">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${err.message}</div>`;
        });
    </script>
</body>
</html>
